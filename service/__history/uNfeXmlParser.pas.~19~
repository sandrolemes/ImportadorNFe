unit uNfeXmlParser;

interface

uses
  System.SysUtils,
  System.Classes,
  Xml.XMLDoc,
  Xml.XMLIntf,
  uDocumentoNfeDTO,
  uDocumentoNfeItemDTO;

type
  TNfeXmlParser = class
  public
    class procedure LerXml(
      const AArquivo: string;
      ADocumento: TDocumentoNfeDTO;
      AItens: TList
    );

    class procedure LerXml(const pArquivo: string; pDocNFeDTO: TDocumentoNfeDTO; pListaItens: TList);
  end;

implementation

uses
  uUtils;



class procedure TNfeXmlParser.LerXml(const pArquivo: string; pDocNFeDTO: TDocumentoNfeDTO; pListaItens: TList);
var
  Xml: IXMLDocument;
  NFe, InfNFe, Det: IXMLNode;
  I: Integer;
  ItemDTO: TDocumentoNfeItemDTO;
begin
  Xml := TXMLDocument.Create(nil);
  Xml.LoadFromFile(pArquivo);
  Xml.Active := True;

  NFe := Xml.DocumentElement.ChildNodes.FindNode('NFe');
  if NFe = nil then
    raise Exception.Create('XML inválido: tag NFe não encontrada');

  InfNFe := NFe.ChildNodes.FindNode('infNFe');
  if InfNFe = nil then
    raise Exception.Create('XML inválido: tag infNFe não encontrada');

  pDocNFeDTO.CHAVE_ACESSO := uUtils.retornarApenasNumeros(InfNFe.Attributes['Id']);

  pDocNFeDTO.NUMERO := InfNFe.ChildNodes['ide'].ChildNodes['nNF'].Text;
  pDocNFeDTO.SERIE := InfNFe.ChildNodes['ide'].ChildNodes['serie'].Text;
  pDocNFeDTO.DT_EMISSAO := uUtils.XmlIso8601ToDateTime( InfNFe.ChildNodes['ide'].ChildNodes['dhEmi'].Text );
  pDocNFeDTO.EMIT_CNPJ_CPF := InfNFe.ChildNodes['emit'].ChildNodes.FindNode('CNPJ').Text;
  pDocNFeDTO.EMIT_RAZAO := InfNFe.ChildNodes['emit'].ChildNodes['xNome'].Text;

  pDocNFeDTO.DEST_CNPJ_CPF := InfNFe.ChildNodes['dest'].ChildNodes.FindNode('CNPJ').Text;
  pDocNFeDTO.DEST_RAZAO := InfNFe.ChildNodes['dest'].ChildNodes['xNome'].Text;

  pDocNFeDTO.VL_TOTAL := uUtils.XmlStrToFloat( InfNFe.ChildNodes['total'].ChildNodes['ICMSTot'].ChildNodes['vNF'].Text );

  for I := 0 to InfNFe.ChildNodes.Count - 1 do
  begin
    if InfNFe.ChildNodes[I].NodeName = 'det' then
    begin
      Det := InfNFe.ChildNodes[I];
      ItemDTO := TDocumentoNfeItemDTO.Create;

      ItemDTO.ITEM := StrToIntDef(Det.Attributes['nItem'], I + 1);
      ItemDTO.DESCRICAO := Det.ChildNodes['prod'].ChildNodes['xProd'].Text;
      ItemDTO.NCM := Det.ChildNodes['prod'].ChildNodes.FindNode('NCM').Text;
      ItemDTO.QUANTIDADE := uUtils.XmlStrToFloat( Det.ChildNodes['prod'].ChildNodes['qCom'].Text );
      ItemDTO.VL_UNITARIO := uUtils.XmlStrToFloat( Det.ChildNodes['prod'].ChildNodes['vUnCom'].Text );
      ItemDTO.VL_TOTAL := uUtils.XmlStrToFloat( Det.ChildNodes['prod'].ChildNodes['vProd'].Text );

      pListaItens.Add(ItemDTO);
    end;
  end;
end;

end.


